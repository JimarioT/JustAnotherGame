<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
		<link rel="stylesheet" type="text/css" href="css/bootstrap-theme.css">
		<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">		
		<script type="text/javascript" src="js/jquery-2.2.2.js"></script>
		<script type="text/javascript" src="js/bootstrap.js"></script>

		<script type="text/javascript" src="js/resourcesFunctionality.js"></script>
		<script type="text/javascript" src="js/saveFunctionality.js"></script>
		
		<title>Just a Game</title>

		<style type="text/css">
			.unitCreation {
				margin-top: 10px;
				margin-bottom: 10px;
			}

			.fa-plus {
				margin-left: 5px;
			}

			.fa-minus {
				margin-right: 5px;
			}

			textarea {
				height: 400px;
			}
		</style>

	</head>
	<body>

		<div class="pgOne" style="display:none;">
			<div class="container">
				<div class="row text-center">
					<div class="col-xs-12">
						<h3 class="text-center">TBA</h3>
						<button class="btn btn-primary btnContinue col-xs-4 col-xs-offset-4">Continue</button>
						<br/>
						<button class="btn btn-primary btnNewCampaign col-xs-4 col-xs-offset-4">New Campaign</button>
						<br/>
						<button class="btn btn-primary btnOptions col-xs-4 col-xs-offset-4">Options</button>
						<br/>
						<button class="btn btn-primary btnExit col-xs-4 col-xs-offset-4">Exit</button>	
					</div>					
				</div>
			</div>
		</div>

		<div class="pgTwo">
			<div class="container">
				<div class="row text-left">
					<div class="col-xs-12">
						<!--<div class="col-md-3">
							<span>Base: </span> <span> A Name </span>
						</div>-->
						<div class="col-xs-12 goldCont">
							<span class="col-xs-1">Gold: </span> <span class="col-xs-2 playersGold"> 0 </span>
						</div>
						<div class="col-xs-12 woodCont">
							<span class="col-xs-1">Wood: </span> <span class="col-xs-2 playersWood"> 0 </span>
							<div class="col-xs-4">
								<i class="fa fa-minus woodMinus" onclick="removeWorkforce('wood')"></i>
								<span class="woodWorkforce"> 0 </span>
								<i class="fa fa-plus woodPlus" onclick="calculateWorkforce('wood')"></i>								
								<span>Working Villager(s)</span>
							</div>
						</div>
						<div class="col-xs-12 stoneCont">
							<span class="col-xs-1">Stone: </span> <span class="col-xs-2 playersStone"> 0 </span>
							<div class="col-xs-4">
								<i class="fa fa-minus stoneMinus" onclick="removeWorkforce('stone')"></i>
								<span class="stoneWorkforce"> 0 </span>
								<i class="fa fa-plus stonePlus" onclick="calculateWorkforce('stone')"></i>								
								<span>Working Villager(s)</span>
							</div>							
						</div>
						<div class="col-xs-12 foodCont">
							<span class="col-xs-1">Food: </span> <span class="col-xs-2 playersFood"> 0 </span>	
							<div class="col-xs-4">
								<i class="fa fa-minus foodMinus" onclick="removeWorkforce('food')"></i>
								<span class="foodWorkforce"> 0 </span>
								<i class="fa fa-plus foodPlus" onclick="calculateWorkforce('food')"></i>								
								<span>Working Villager(s)</span>
							</div>
						</div>
						<div class="col-xs-12">
							<span class="col-xs-1">Villagers: </span> <span class="col-xs-2 playersVillagers"> 0 </span>	
						</div>
						<div class="col-xs-4">
							<div class="row hovelList">
								
							</div>
						</div>
						<div class="col-xs-5 col-xs-offset-7">
							<textarea class="col-xs-10 col-xs-offset-1"></textarea>
						</div>
						
						<div class="col-xs-12">
							<div class="col-xs-4 unitCreation">
								<button class="btnBarracks" style="display: none;"> Create Some Troops </button>
							</div>
						</div>
						<div style="display: none;">
							<button onclick="saveSession()">Save Game</button>
							<input id="fileToLoad" type="file" />
							<button onclick="loadSession()">Load Game</button>	
						</div>
						

						<div class="row">
							<div class="col-xs-6">
								<button class="btn" data-toggle="modal" data-target="#buildingModal">Create Building</button>
							</div>
							<div class="col-xs-6"></div>
						</div>
					</div>					
				</div>
			</div>
		</div>

		<div class="modal fade" id="buildingModal" role="dialog">
    		<div class="modal-dialog">
    
	      		<!-- Modal content-->
	      		<div class="modal-content">
	        		<div class="modal-header">
	          			<button type="button" class="close" data-dismiss="modal">&times;</button>
	          			<h4 class="modal-title">Modal Header</h4>
	        		</div>
		        	<div class="modal-body">
		          		<p>Select a build from the list</p>
		      			<button class="btn" data-dismiss="modal" onclick="createBuilding('barracks')">
		      				Barracks	
		      			</button>
		      			<button class="btn" data-dismiss="modal" onclick="createBuilding('hovels')">
		      				Hovel
		      			</button>
		      			<button class="btn" data-dismiss="modal" onclick="createBuilding('woodHuts')">
		      				Wood hut	
		      			</button>
		      			<button class="btn" data-dismiss="modal" onclick="createBuilding('quarry')">
		      				Quarry	
		      			</button>
		      			<button class="btn" data-dismiss="modal" onclick="createBuilding('farms')">
		      				Farm	
		      			</button>
		        	</div>
		        	<div class="modal-footer">
		        	  	<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
		        	</div>
		        </div>
		    </div>
      	</div>
      
   

		<script type="text/javascript">		
			var intervalCarrier;
			var boredText = "";

			var woodProdMod = 0;
			var quarryProdMod = 0;
			var farmProdMod = 0;

			var boredVillagers = [
				"*Hey boss, it's a tad boring over here! Let me help!*",
				"*It's nice, not doing anything! But how will I pay my taxes with no job?*",
				"*Psit ... Boss ... Hey ... You forgot about me?*",
				"**Singing in the rain Tune* ... I'm scraaatching over here!*",
				"*We need to add a WiFi antenna for when we are doing NOTHING*",
				"It's a nice day today, for not doing anything"
			];

			var resources = {
				'gold' : 0 ,
				'wood': 0 ,
				'stone': 0,
				'food': 0,
				'villagers': 6
			};

			var campaignInfo = {
				'playerName': '',
				'playerAttr': {
					'health': 100,
					'atk': 5,
					'def': 5
				},
				'baseInfo': {
					'buildings': {
						'hovels': {
							'built' : 0,
							'maxNumber': 5,
							'buildingInfo': {
								'buildingStats': {
									'active': false,
									'level': 0,
									'productionBonus': 0,
									'highestLvlUnit': 0
								},								
								'levelRequirements': [
									{'gold': 100, 'wood': 50, 'stone': 0},
									{'gold': 400, 'wood': 200, 'stone': 40},
									{'gold': 800, 'wood': 400, 'stone': 80},
									{'gold': 1600, 'wood': 800, 'stone': 160},
									{'gold': 3200, 'wood': 1600, 'stone': 320}
								],
								'levelBonus': [
									{'villagers': 5},
									{'villagers': 7},
									{'villagers': 10}
								],
								'builtStatus': [
								]
							}
						},
						'barracks': {
							'built' : 0,
							'maxNumber': 2,
							'buildingInfo': {
								'buildingStats': {
									'active': false,
									'level': 0,
									'productionBonus': 0,
									'highestLvlUnit': 0
								},								
								'levelRequirements': [
									{'gold': 100, 'wood': 50, 'stone': 50},
									{'gold': 1000, 'wood': 500, 'stone': 500}
								],
								'levelBonus': [
									{'productionBonus': 0, 'highestLvlUnit': 0},
									{'productionBonus': 0.2, 'highestLvlUnit': 1},
									{'productionBonus': 0.5, 'highestLvlUnit': 2}
								]
							}
						},
						'woodHuts': {
							'built' : 0,
							'maxNumber': 2,
							'buildingInfo': {
								'buildingStats': {
									'active': false,
									'level': 0,
									'productionBonus': 0,
									'highestLvlUnit': 0
								},								
								'levelRequirements': [
									{'gold': 100, 'wood': 50, 'stone': 0},
									{'gold': 200, 'wood': 250, 'stone': 100},
									{'gold': 400, 'wood': 1250, 'stone': 200},
									{'gold': 800, 'wood': 6250, 'stone': 400},
									{'gold': 1600, 'wood': 32250, 'stone': 800}
								],
								'levelBonus': [
									{'productionBonus': 1, 'maxAllowedWorkers': 2},
									{'productionBonus': 1.3, 'maxAllowedWorkers': 4},
									{'productionBonus': 1.6, 'maxAllowedWorkers': 6},
								],
								'builtStatus': [									
								]
							}
						},
						'quarry': {
							'built' : 0,
							'maxNumber': 2,
							'buildingInfo': {
								'buildingStats': {
									'active': false,
									'level': 0,
									'productionBonus': 0,
									'highestLvlUnit': 0
								},								
								'levelRequirements': [
									{'gold': 100, 'wood': 100, 'stone': 0},
									{'gold': 200, 'wood': 500, 'stone': 100},
									{'gold': 400, 'wood': 1000, 'stone': 200},
									{'gold': 800, 'wood': 2000, 'stone': 400},
									{'gold': 1600, 'wood': 4000, 'stone': 800}
								],
								'levelBonus': [
									{'productionBonus': 1, 'maxAllowedWorkers': 2},
									{'productionBonus': 1.3, 'maxAllowedWorkers': 4},
									{'productionBonus': 1.6, 'maxAllowedWorkers': 6},
								],
								'builtStatus': [									
								]
							}
						},
						'farms': {
							'built' : 0,
							'maxNumber': 2,
							'buildingInfo': {
								'buildingStats': {
									'active': false,
									'level': 0,
									'productionBonus': 0,
									'highestLvlUnit': 0
								},								
								'levelRequirements': [
									{'gold': 100, 'wood': 100, 'stone': 0},
									{'gold': 200, 'wood': 500, 'stone': 100},
									{'gold': 400, 'wood': 1000, 'stone': 200},
									{'gold': 800, 'wood': 2000, 'stone': 400},
									{'gold': 1600, 'wood': 4000, 'stone': 800}
								],
								'levelBonus': [
									{'productionBonus': 1, 'maxAllowedWorkers': 2},
									{'productionBonus': 1.3, 'maxAllowedWorkers': 4},
									{'productionBonus': 1.6, 'maxAllowedWorkers': 6},
								],
								'builtStatus': [									
								]
							}
						}
					},
					'units': {
						'villager': {
							'health': 10,
							'atk': 2,
							'def': 2
						}
					},
					'jobs': {
						'woodcutter': {
							'healthMod': 1.8,
							'atkMod': 1.8,
							'defMod': 1.8
						},
						'stonecutter': {
							'healthMod': 1.7,
							'atkMod': 1.7,
							'defMod': 1.7
						},
						'farmer': {
							'healthMod': 1.5,
							'atkMod': 1.5,
							'defMod': 1.5
						},
						'military': {
							'healthMod': 2,
							'atkMod': 2,
							'defMod': 2
						},
						'villager': {
							'healthMod': 1,
							'atkMod': 1,
							'defMod': 1
						}
					}
				}
			}

			var loadedSession = '';

			function calculateWorkforce(job, a) {

				var workforce = parseFloat($('.woodWorkforce').text()) + parseFloat($('.stoneWorkforce').text()) + parseFloat($('.foodWorkforce').text());
				
				console.log($('div[data-building="WoodHut0"]').length);					

				if($('div[data-building="WoodHut0"]').length > 0) {
					
					workforce = workforce + parseFloat($('div[data-building="WoodHut0"]').attr('data-workers'));
					
				}

				var test = campaignInfo.baseInfo.buildings.woodHuts.buildingInfo.builtStatus;
				if(test.length > 0) {
					for (var i =0; i < test.length; i++) {
						workforce = workforce + test[i].currentlyWorking;
					}
				}

				if (workforce < resources.villagers) {
					addWorkforce(job, a);
				}				
			}

			function addWorkforce(job, a) {	
				var workforce;
				if (job == 'wood') {					
					workforce = $('.woodWorkforce').text();					
					workforce ++;					
					$('.woodWorkforce').text(workforce);
				}
				if (job == 'stone') {
					workforce = $('.stoneWorkforce').text();					
					workforce ++;
					$('.stoneWorkforce').text(workforce);
				}
				if (job == 'food') {
					workforce = $('.foodWorkforce').text();					
					workforce ++;
					$('.foodWorkforce').text(workforce);
				}
				if (job == 'woodCutter') {
					var woodCutterWorkers = $(a).parent().attr('data-workers');					
					$(a).parent().attr('data-workers', parseFloat(woodCutterWorkers) + 1);
					workforce = $('.woodCutterWorkforce').text();					
					workforce ++;
					$('.woodCutterWorkforce').text(workforce);
				}

				clearInterval(intervalCarrier);
				generateResources();
			}

			function removeWorkforce(job, a) {
				var workforce;
				if (job == 'wood') {
					workforce = $('.woodWorkforce').text();
					if(workforce > 0) {
						workforce --;
						$('.woodWorkforce').text(workforce);
					}
				}
				if (job == 'stone') {
					workforce = $('.stoneWorkforce').text();
					if(workforce > 0) {
						workforce --;
						$('.stoneWorkforce').text(workforce);
					}					
				}
				if (job == 'food') {
					workforce = $('.foodWorkforce').text();
					if(workforce > 0) {
						workforce --;
						$('.foodWorkforce').text(workforce);
					}					
				}
				if (job == 'woodCutter') {
					workforce = $('.woodCutterWorkforce').text();
					if(workforce > 0) {
						workforce --;
						$('.woodCutterWorkforce').text(workforce);
					}					
				}

			}

			function generateResources() {				
				var farmsBuilt = 0;
				var woodProdMod = 0;
				var quarryProdMod = 0;
				
				woodProdMod = resourceProdMod('woodHuts');
				quarryProdMod = resourceProdMod('quarry');
				farmProdMod = resourceProdMod('farms');
				
				var goldIncrease = resources.villagers * 1;
				var woodIncrease = (10 * parseFloat($('.woodWorkforce').text())) * woodProdMod;
				var stoneIncrease = (10 * parseFloat($('.stoneWorkforce').text())) * quarryProdMod;
				var foodIncrease = (10 * parseFloat($('.foodWorkforce').text())) * farmProdMod;

				intervalCarrier = setInterval(function() {
					resources.gold = resources.gold + goldIncrease;
					resources.wood = resources.wood + woodIncrease;
					resources.stone = resources.stone + stoneIncrease;
					resources.food = resources.food + foodIncrease;
					$('.playersGold').text(resources.gold);
					$('.playersWood').text(resources.wood);
					$('.playersStone').text(resources.stone);
					$('.playersFood').text(resources.food);
					$('.playersVillagers').text(resources.villagers);
				//}, 5000);
				}, 500);
			}
  			
			function createBuilding(building) {				
				//Check how many buildings of that kind are built
				var buildingsBuilt = campaignInfo.baseInfo.buildings[building].built;
				
				//Maximum allowed buildings
				var maxBuildingssAllowed = campaignInfo.baseInfo.buildings[building].maxNumber;

				//Set the Level requirement variable (for cleared code)
				var lvlRequirement = campaignInfo.baseInfo.buildings[building].buildingInfo.levelRequirements[0];

				if (buildingsBuilt < maxBuildingssAllowed ) {

					//Check if the stored materials are sufficient for the procedure
					var sufficientGold = resources.gold >= lvlRequirement.gold;
					var sufficientWood = resources.wood >= lvlRequirement.wood;
					var sufficientStone = resources.stone >= lvlRequirement.stone;

					//If the materials are sufficient then proceed to create the building and reduce the total materials
					if ( sufficientGold && sufficientWood && sufficientStone ) {
						var buildingVar = campaignInfo.baseInfo.buildings[building].buildingInfo.buildingStats;

						buildingVar.active = true;
						buildingVar.level = 1;

						resources.gold = resources.gold - lvlRequirement.gold;
						resources.wood = resources.wood - lvlRequirement.wood;
						resources.stone = resources.stone - lvlRequirement.stone;

						campaignInfo.baseInfo.buildings[building].built = campaignInfo.baseInfo.buildings[building].built + 1;
						checkWhichBuilding(building);
					}

					//Notify the user that he needs more resources
					else {
						alert('Insufficient Resources');
					}
				}

				//Notify the user that he can't have any more identical buildings
				else {
					alert("You can't have more buildings of that kind");
				}
			}

			function checkWhichBuilding(building) {
				clearInterval(intervalCarrier);
				addBuildingToList(building);
				/*if (building == 'barracks') {
					var buildingStatsctive = campaignInfo.baseInfo.buildings[building].buildingInfo.buildingStats.active;
					if(buildingStatsctive == true) {
						$('.btnBarracks').css('display','block');
					}
				}*/
			}

			function resourceProdMod(building) {
				var buildingBuilt = campaignInfo.baseInfo.buildings[building].built;
				if (buildingBuilt == 1) {
					buildingProdMod = campaignInfo.baseInfo.buildings[building].buildingInfo.levelBonus[0].productionBonus;
				}
				else if (buildingBuilt == 2) {
					buildingProdModA = campaignInfo.baseInfo.buildings[building].buildingInfo.levelBonus[0].productionBonus;
					buildingProdModB = campaignInfo.baseInfo.buildings[building].buildingInfo.levelBonus[0].productionBonus;
					buildingProdMod = buildingProdModA + buildingProdModB;
				}
				else {
					buildingProdMod = 0.5;
				}
				return buildingProdMod;
			}

			function addBuildingToList(building) {
				var buildingName = "", jobName = "";
				if(building == 'hovels') {
					buildingName = "Hovel";
					resources.villagers = resources.villagers + 5;
				}
				else if(building == 'woodHuts') {
					buildingName = "Wood Hut"; 
					jobName = "woodCutter";
				}
				else if(building == 'quarry') buildingName = 'Quarry';
				else if(building == 'farms') buildingName = 'Farm';				
				var totalBuildings = campaignInfo.baseInfo.buildings[building].buildingInfo.builtStatus;
				var item = '<div data-building="' + buildingName.replace(" ", "") + totalBuildings.length + '" data-workers="0">' +
							'<a>' + buildingName + '<span class="' + building + 'Lvl"> LvL 1</span></a>' +
							
								'<i class="fa fa-minus foodMinus" onclick="removeWorkforce(\'' + jobName + '\', this)"></i>' +
								'<span id="" class="'+ jobName +'Workforce"> 0 </span>' +
								'<i class="fa fa-plus foodPlus" onclick="calculateWorkforce(\'' + jobName + '\', this)"></i>' +	
							'</div>';
				var prod = campaignInfo.baseInfo.buildings[building].buildingInfo.levelBonus[0].productionBonus;
				var index = {'level': 1, 'productionBonus': prod, 'currentlyWorking': 0};
				totalBuildings.push(index);
				$('.hovelList').append(item);				
				generateResources();
			}

			function villagersFeedback() {				
				var repeats = 0;
				
				setInterval(function() {
					var workforce = parseFloat($('.woodWorkforce').text()) + parseFloat($('.stoneWorkforce').text()) + parseFloat($('.foodWorkforce').text());
					if(workforce < resources.villagers) {
						var boredCase = Math.floor(((Math.random() * 10) + 1) / 2);						
						boredText = boredText + boredVillagers[boredCase] + '\n';
						$('textarea').val(boredText);
						repeats ++;						
					}
					else if (workforce == resources.villagers){
						var emptyString = "";
						$('textarea').val(emptyString);
					}
					if(repeats == 10) {
						boredText = "";
						$('textarea').val(boredText);
						repeats = 0;
					}
				}, 10000);				
			}

			$(document).ready(function() {
				//navigator.webkitPersistentStorage.requestQuota(1024*1024, function() {
 				//	window.webkitRequestFileSystem(window.PERSISTENT , 1024*1024, SaveDatFileBro);
				//});

				generateResources();
				villagersFeedback();
			});
		</script>
	</body>
</html>